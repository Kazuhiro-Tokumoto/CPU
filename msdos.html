<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>MYDOS 1.0</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
*{box-sizing:border-box;margin:0;padding:0;}
html,body{width:100%;height:100%;background:#000;color:#ccc;font-family:'Share Tech Mono',monospace;overflow:hidden;}
body::after{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,rgba(0,0,0,.05) 0,rgba(0,0,0,.05) 1px,transparent 1px,transparent 2px);pointer-events:none;z-index:999;}
.layout{display:flex;flex-direction:column;height:100vh;}
.bar{display:flex;align-items:center;gap:8px;padding:3px 10px;background:#000;border-bottom:1px solid #111;flex-shrink:0;font-size:11px;}
.bar-logo{color:#666;letter-spacing:3px;font-size:12px;}.bar-logo b{color:#aaa;}
.bspc{flex:1;}
.tbtn{padding:2px 8px;border:1px solid #1a1a1a;background:#000;color:#444;font-family:'Share Tech Mono',monospace;font-size:10px;cursor:pointer;transition:all .1s;}
.tbtn:hover{border-color:#555;color:#aaa;}.tbtn.red:hover{border-color:#700;color:#c33;}
.main{display:flex;flex:1;overflow:hidden;}
/* ターミナル — クリックでフォーカス */
#screen{
  flex:1;padding:6px 10px;overflow-y:auto;
  white-space:pre-wrap;word-break:break-all;
  font-size:13px;line-height:1.45;color:#ccc;
  background:#000;cursor:text;outline:none;
  min-width:0;
}
#screen:focus{outline:none;}
/* カーソル点滅 */
#cursor{display:inline-block;width:8px;background:#888;animation:blink .8s step-end infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}
/* hidden input — IME対応 */
#hi{position:absolute;opacity:0;pointer-events:none;width:1px;height:1px;top:0;left:0;}
/* サイドパネル */
.side{width:200px;display:flex;flex-direction:column;background:#000;border-left:1px solid #111;flex-shrink:0;}
.side-label{padding:2px 8px;font-size:9px;color:#2a2a2a;border-bottom:1px solid #0d0d0d;letter-spacing:1px;}
.disk-stat{padding:5px 8px;font-size:10px;color:#333;border-bottom:1px solid #0d0d0d;line-height:1.9;}
.disk-stat span{color:#555;}
#fileList{flex:1;overflow-y:auto;}
.fe{display:flex;justify-content:space-between;padding:2px 8px;font-size:11px;color:#333;cursor:pointer;border-bottom:1px solid #050505;transition:background .08s;}
.fe:hover{background:#0a0a0a;color:#777;}
.fe .fn{color:#666;}.fe.dir .fn{color:#444;}.fe .fs{font-size:10px;color:#222;}
.side-btns{padding:4px;display:flex;flex-direction:column;gap:3px;border-top:1px solid #0d0d0d;}
.sbtn{padding:3px 7px;background:#000;border:1px solid #111;color:#333;font-family:'Share Tech Mono',monospace;font-size:10px;cursor:pointer;text-align:left;transition:all .1s;}
.sbtn:hover{border-color:#444;color:#888;}.sbtn.danger:hover{border-color:#400;color:#a33;}
.sbar{display:flex;align-items:center;gap:12px;padding:2px 10px;background:#000;border-top:1px solid #0d0d0d;font-size:9px;color:#2a2a2a;flex-shrink:0;}
.sbar span{color:#444;}
#statusMsg{color:#555;}
::-webkit-scrollbar{width:3px;}::-webkit-scrollbar-track{background:#000;}::-webkit-scrollbar-thumb{background:#111;}
#dropOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);border:1px dashed #333;z-index:100;align-items:center;justify-content:center;font-size:14px;color:#444;letter-spacing:3px;}
#dropOverlay.active{display:flex;}
</style>
</head>
<body>
<div id="dropOverlay">DROP FILES → A:\</div>
<div class="layout">
  <div class="bar">
    <span class="bar-logo"><b>MY</b>DOS</span>
    <span style="color:#1a1a1a">|</span>
    <span style="color:#2a2a2a;font-size:10px">FAT12 1.44MB</span>
    <div class="bspc"></div>
    <button class="tbtn" onclick="MSDos.downloadImg()">disk.img</button>
    <button class="tbtn" onclick="document.getElementById('importInput').click()">import</button>
    <button class="tbtn red" onclick="doFormat()">format</button>
    <input type="file" id="importInput" multiple style="display:none" onchange="importFiles(event)">
  </div>
  <div class="main">
    <div id="screen" tabindex="0">
      <span id="screenText"></span><span id="cursor">&nbsp;</span>
    </div>
    <input id="hi" autocomplete="off" spellcheck="false" autocorrect="off" autocapitalize="none">
    <div class="side">
      <div class="side-label">DISK A:</div>
      <div class="disk-stat">
        <div>形式: <span>FAT12</span></div>
        <div>容量: <span>1,474,560B</span></div>
        <div>空き: <span id="freeBytes">—</span></div>
        <div>FILES: <span id="fileCount">0</span></div>
      </div>
      <div class="side-label" style="border-top:1px solid #0d0d0d">A:\<span id="cwdLabel"></span></div>
      <div id="fileList"></div>
      <div class="side-btns">
        <button class="sbtn" onclick="refreshUI()">↺ 更新</button>
        <button class="sbtn" onclick="MSDos.downloadImg()">↓ disk.img</button>
        <button class="sbtn" onclick="document.getElementById('importInput').click()">↑ import</button>
        <button class="sbtn danger" onclick="doFormat()">⚠ format</button>
      </div>
    </div>
  </div>
  <div class="sbar">
    <span id="cwdBar">A:\</span>
    <div class="bspc"></div>
    <span id="statusMsg"></span>
  </div>
</div>
<script src="./dist/cpu8086.js"></script>
<script src="./dist/msdos.js"></script>
<script>
// ============================================================
// ターミナルUI — screenTextに直接書く、hi(hidden input)でキー受け取る
// ============================================================
const screenEl   = document.getElementById('screen');
const screenText = document.getElementById('screenText');
const hiInput    = document.getElementById('hi');
let   bufText    = '';          // 画面バッファ
let   lineInput  = '';          // 現在の入力行
let   inExec     = false;

// Terminal実装 (msdos.jsのTerminalを上書き)
class ScreenTerminal {
  print(s)    { bufText += s;   render(); }
  println(s='') { bufText += (s||'') + '\n'; render(); }
  clear()     { bufText = '';   render(); }
}

function render() {
  // 画面バッファ + 現在の入力行 + カーソル
  screenText.textContent = bufText + lineInput;
  screenEl.scrollTop = screenEl.scrollHeight;
}

// screenをクリックしたらhiにフォーカス
screenEl.addEventListener('click', () => hiInput.focus());
screenEl.addEventListener('focus', () => hiInput.focus());

// hi inputにフォーカスするときカーソル表示
hiInput.addEventListener('focus',  () => document.getElementById('cursor').style.display='inline-block');
hiInput.addEventListener('blur',   () => document.getElementById('cursor').style.display='none');

// キー入力
hiInput.addEventListener('keydown', e => {
  // ── EDIT モード ──
  if(window._editInstance && window._editInstance.active) {
    e.preventDefault();
    window._editInstance.onKey(e.key, e.ctrlKey, e.shiftKey);
    return;
  }
  // ── COPY CON モード ──
  if(window._copyConInstance && window._copyConInstance.active) {
    if(e.ctrlKey && (e.key==='z'||e.key==='Z')){
      e.preventDefault();
      window._copyConInstance.onCtrlZ();
      if(window.onDiskChange) window.onDiskChange();
      return;
    }
    if(e.ctrlKey && (e.key==='c'||e.key==='C')){
      e.preventDefault();
      window._copyConInstance.onCtrlC();
      return;
    }
    if(e.key==='Enter'){
      e.preventDefault();
      const line=lineInput;
      bufText+=lineInput+'\n';
      window._copyConInstance.onLine(line);
      lineInput='';
      render();
      return;
    }
    if(e.key==='Backspace'){
      e.preventDefault();
      if(lineInput.length>0){lineInput=lineInput.slice(0,-1);render();}
      return;
    }
    // printable chars handled by input event below
    return;
  }
  // ── CPU実行中 ──
  if(window._cpuRunning && window._cpuInstance) {
    let ascii=0, scan=0;
    if(e.key.length===1){ascii=e.key.charCodeAt(0);scan=ascii;}
    else if(e.key==='Enter'){ascii=0x0D;scan=0x1C;}
    else if(e.key==='Backspace'){ascii=0x08;scan=0x0E;}
    else if(e.key==='Escape'){ascii=0x1B;scan=0x01;}
    else if(e.key==='ArrowUp'){scan=0x48;ascii=0;}
    else if(e.key==='ArrowDown'){scan=0x50;ascii=0;}
    else if(e.key==='ArrowLeft'){scan=0x4B;ascii=0;}
    else if(e.key==='ArrowRight'){scan=0x4D;ascii=0;}
    if(ascii||scan){
      window._cpuInstance.pushKey(scan,ascii);
      window._cpuInstance.halted=false;
    }
    e.preventDefault();return;
  }
  if(inExec) return;
  if(e.key === 'Enter') {
    e.preventDefault();
    const line = lineInput;
    bufText += lineInput + '\n';
    lineInput = '';
    render();
    inExec = true;
    MSDos.shell.execute(line);
    inExec = false;
    if(window.onDiskChange) window.onDiskChange();
  } else if(e.key === 'Backspace') {
    e.preventDefault();
    if(lineInput.length > 0) { lineInput = lineInput.slice(0,-1); render(); }
  } else if(e.key === 'ArrowUp') {
    e.preventDefault();
    const h = MSDos.shell.history;
    if(!h.length) return;
    MSDos.shell.histIdx = Math.min(MSDos.shell.histIdx+1, h.length-1);
    lineInput = h[MSDos.shell.histIdx];
    render();
  } else if(e.key === 'ArrowDown') {
    e.preventDefault();
    MSDos.shell.histIdx = Math.max(MSDos.shell.histIdx-1, -1);
    lineInput = MSDos.shell.histIdx < 0 ? '' : MSDos.shell.history[MSDos.shell.histIdx];
    render();
  } else if(e.key === 'Tab') {
    e.preventDefault();
    tabComplete();
  } else if(e.ctrlKey && e.key === 'c') {
    bufText += '^C\n';
    lineInput = '';
    render();
    MSDos.shell.prompt();
  }
});

// printable文字 (IME経由も含む)
hiInput.addEventListener('input', e => {
  const v = hiInput.value;
  if(v) {
    // EDITモードではonKeyに文字を渡す
    if(window._editInstance && window._editInstance.active) {
      for(const ch of v) window._editInstance.onKey(ch, false, false);
      hiInput.value='';
      return;
    }
    lineInput += v;
    hiInput.value = '';
    render();
  }
});

function tabComplete() {
  const parts = lineInput.split(/\s+/);
  const last  = parts[parts.length-1];
  if(!last) return;
  const entries = MSDos.disk.listDir(MSDos.shell.cwdParts)||[];
  const matches = entries.filter(e => e.name.toUpperCase().startsWith(last.toUpperCase()));
  if(matches.length === 1) {
    parts[parts.length-1] = matches[0].name;
    lineInput = parts.join(' ');
    render();
  } else if(matches.length > 1) {
    bufText += '\n' + matches.map(m=>m.name.padEnd(14)).join('') + '\n';
    MSDos.shell.prompt();
  }
}

// ============================================================
// 初期化
// ============================================================
window.addEventListener('DOMContentLoaded', () => {
  // MSDos.termをScreenTerminalに差し替え
  const fakeTerm = new ScreenTerminal();
  window.onDiskChange = refreshUI;

  // MSDos.initの代わりに直接セットアップ
  MSDos.term  = fakeTerm;
  MSDos.disk  = new FAT12Disk();
  if(!MSDos.disk.isFormatted()) {
    MSDos.disk.format();
    fakeTerm.println('[新しいディスクをフォーマットしました]');
  } else {
    fakeTerm.println('[ディスクをlocalStorageから読み込みました]');
  }
  MSDos.shell = new DOSShell(MSDos.disk, fakeTerm);
  MSDos.shell.start();

  refreshUI();
  hiInput.focus();

  // EDITレンダリング
  window._editRender = function(text, cursorRow, cursorCol) {
    screenText.textContent = text;
    screenEl.scrollTop = 0; // EDITは固定画面
  };

  // EDIT終了
  window._editExit = function() {
    // バッファを復帰
    screenText.textContent = bufText + lineInput;
    screenEl.scrollTop = screenEl.scrollHeight;
  };

  // VRAMレンダリングモード
  let _vramMode = false;
  let _savedBuf = '';

  window.renderVRAM = function() {
    if(!window._cpuMem) return;
    const mem=window._cpuMem;
    const VRAM=0xB8000, COLS=80, ROWS=25;
    let text='';
    for(let row=0;row<ROWS;row++){
      for(let col=0;col<COLS;col++){
        const addr=VRAM+(row*COLS+col)*2;
        const ch=mem.read8(addr);
        text+=(ch>=0x20&&ch<0x7F)?String.fromCharCode(ch):' ';
      }
      if(row<ROWS-1)text+='\n';
    }
    // VRAMモード中はbufTextをVRAM内容で上書き
    screenText.textContent=text;
    screenEl.scrollTop=screenEl.scrollHeight;
  };

  window.exitVRAMMode = function() {
    // VRAMモード終了 → バッファ復帰
    screenText.textContent=bufText;
    screenEl.scrollTop=screenEl.scrollHeight;
  };

  setInterval(() => {
    const c = MSDos.shell ? MSDos.shell.cwdStr() : 'A:\\';
    document.getElementById('cwdBar').textContent = c;
    document.getElementById('cwdLabel').textContent = MSDos.shell.cwdParts.join('\\');
  }, 200);
});

// ============================================================
// サイドパネル
// ============================================================
function refreshUI() {
  if(!MSDos.disk||!MSDos.shell) return;
  const entries = MSDos.disk.listDir(MSDos.shell.cwdParts)||[];
  const el = document.getElementById('fileList');
  if(!entries.length) {
    el.innerHTML = '<div class="fe" style="cursor:default;color:#1a1a1a">（空）</div>';
  } else {
    el.innerHTML = entries.map(e => {
      const isDir = e.attr & 0x10;
      const label = isDir ? '['+e.name+']' : e.name;
      const size  = isDir ? 'DIR' : e.size+'B';
      const act   = isDir ? `sendCmd('CD ${e.name}')` : `sendCmd('TYPE ${e.name}')`;
      return `<div class="fe${isDir?' dir':''}" onclick="${act}"><span class="fn">${label}</span><span class="fs">${size}</span></div>`;
    }).join('');
  }
  const free = MSDos.disk.freeClusters()*512;
  document.getElementById('freeBytes').textContent = free.toLocaleString()+'B';
  document.getElementById('fileCount').textContent = entries.filter(e=>!(e.attr&0x10)).length;
}

function sendCmd(cmd) {
  lineInput = cmd;
  render();
  hiInput.focus();
  // Enterを自動送信
  bufText += lineInput + '\n';
  lineInput = '';
  render();
  MSDos.shell.execute(cmd);
  refreshUI();
}

function doFormat() {
  if(!confirm('FORMAT: 全データが削除されます。続行しますか？')) return;
  MSDos.format();
  refreshUI();
  setStatus('FORMAT 完了');
}

function importFiles(e) {
  importFileList(Array.from(e.target.files));
  e.target.value='';
}

function importFileList(files) {
  let count=0;
  const proms = files.map(f => new Promise(res => {
    const r = new FileReader();
    r.onload = ev => {
      const bytes = new Uint8Array(ev.target.result);
      const result = MSDos.importFile(f.name, bytes);
      if(result===true) {
        MSDos.term.println(`[インポート: ${f.name.toUpperCase()} (${bytes.length}B) → A:\\]`);
        count++;
      } else {
        MSDos.term.println(`[エラー: ${f.name} - ${result}]`);
      }
      res();
    };
    r.readAsArrayBuffer(f);
  }));
  Promise.all(proms).then(() => {
    MSDos.shell.prompt(); refreshUI();
    setStatus(`${count}ファイルをインポート`);
    hiInput.focus();
  });
}

function setStatus(msg) {
  document.getElementById('statusMsg').textContent=msg;
  setTimeout(()=>document.getElementById('statusMsg').textContent='',3000);
}

// ドラッグ&ドロップ
const overlay=document.getElementById('dropOverlay');
document.addEventListener('dragenter',e=>{e.preventDefault();overlay.classList.add('active');});
document.addEventListener('dragleave',e=>{if(!e.relatedTarget)overlay.classList.remove('active');});
document.addEventListener('dragover',e=>e.preventDefault());
document.addEventListener('drop',e=>{e.preventDefault();overlay.classList.remove('active');importFileList(Array.from(e.dataTransfer.files));});

// postMessage (index.htmlから)
window.addEventListener('message',e=>{
  if(e.data&&e.data.type==='save_com'){
    const{name,bytes}=e.data;
    const r=MSDos.saveCom(name,bytes);
    if(r===true){refreshUI();setStatus('受信: '+name);MSDos.term.println(`[${name} → A:\\ (${bytes.length}B)]`);MSDos.shell.prompt();}
    else setStatus('エラー: '+r);
  }
});
</script>
</body>
</html>