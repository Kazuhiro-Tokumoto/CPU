<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>MYDOS 1.0</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
*{box-sizing:border-box;margin:0;padding:0;}
html,body{width:100%;height:100%;background:#000;color:#ccc;font-family:'Share Tech Mono',monospace;overflow:hidden;}
body::after{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,rgba(0,0,0,.04) 0,rgba(0,0,0,.04) 1px,transparent 1px,transparent 2px);pointer-events:none;z-index:9999;}
.layout{display:flex;flex-direction:column;height:100vh;}
/* bar */
.bar{display:flex;align-items:center;gap:6px;padding:3px 10px;background:#000;border-bottom:1px solid #111;flex-shrink:0;font-size:11px;}
.bar-logo{color:#555;letter-spacing:3px;font-size:12px;}.bar-logo b{color:#999;}
.bspc{flex:1;}
.tbtn{padding:2px 8px;border:1px solid #1a1a1a;background:#000;color:#444;font-family:'Share Tech Mono',monospace;font-size:10px;cursor:pointer;transition:all .1s;}
.tbtn:hover{border-color:#555;color:#aaa;}.tbtn.red:hover{border-color:#700;color:#c33;}
/* main */
.main{display:flex;flex:1;overflow:hidden;position:relative;}
/* screen = text terminal */
#screen{flex:1;padding:6px 10px;overflow-y:auto;white-space:pre-wrap;word-break:break-all;font-size:13px;line-height:1.45;color:#ccc;background:#000;cursor:text;outline:none;min-width:0;}
#cursor{display:inline-block;width:8px;background:#888;animation:blink .8s step-end infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}
/* EDIT cursor */
.edit-cursor{background:#ccc;color:#000;animation:blink .6s step-end infinite;}
/* graphics canvas overlay */
#gfxCanvas{display:none;position:absolute;top:0;left:0;image-rendering:pixelated;cursor:crosshair;}
/* hidden input */
#hi{position:absolute;opacity:0;pointer-events:none;width:1px;height:1px;top:0;left:0;}
/* side */
.side{width:200px;display:flex;flex-direction:column;background:#000;border-left:1px solid #111;flex-shrink:0;}
.side-label{padding:2px 8px;font-size:9px;color:#2a2a2a;border-bottom:1px solid #0d0d0d;letter-spacing:1px;}
.disk-stat{padding:5px 8px;font-size:10px;color:#333;border-bottom:1px solid #0d0d0d;line-height:1.9;}
.disk-stat span{color:#555;}
#fileList{flex:1;overflow-y:auto;}
.fe{display:flex;justify-content:space-between;padding:2px 8px;font-size:11px;color:#333;cursor:pointer;border-bottom:1px solid #050505;transition:background .08s;}
.fe:hover{background:#0a0a0a;color:#777;}.fe .fn{color:#666;}.fe.dir .fn{color:#444;}.fe .fs{font-size:10px;color:#222;}
.side-btns{padding:4px;display:flex;flex-direction:column;gap:3px;border-top:1px solid #0d0d0d;}
.sbtn{padding:3px 7px;background:#000;border:1px solid #111;color:#333;font-family:'Share Tech Mono',monospace;font-size:10px;cursor:pointer;text-align:left;transition:all .1s;}
.sbtn:hover{border-color:#444;color:#888;}.sbtn.danger:hover{border-color:#400;color:#a33;}
/* sbar */
.sbar{display:flex;align-items:center;gap:12px;padding:2px 10px;background:#000;border-top:1px solid #0d0d0d;font-size:9px;color:#2a2a2a;flex-shrink:0;}
.sbar span{color:#444;}#statusMsg{color:#555;}
/* scrollbar */
::-webkit-scrollbar{width:3px;}::-webkit-scrollbar-track{background:#000;}::-webkit-scrollbar-thumb{background:#111;}
/* drop overlay */
#dropOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);border:1px dashed #333;z-index:200;align-items:center;justify-content:center;font-size:14px;color:#444;letter-spacing:3px;}
#dropOverlay.active{display:flex;}
/* gfx mode badge */
#gfxBadge{display:none;position:absolute;top:4px;left:4px;font-size:9px;color:#444;letter-spacing:1px;z-index:10;pointer-events:none;}
</style>
</head>
<body>
<div id="dropOverlay">DROP FILES → A:\</div>
<div class="layout">
  <div class="bar">
    <span class="bar-logo"><b>MY</b>DOS</span>
    <span style="color:#1a1a1a">|</span>
    <span style="color:#2a2a2a;font-size:10px">FAT12 1.44MB</span>
    <div class="bspc"></div>
    <button class="tbtn" onclick="MSDos.downloadImg()" title="disk.imgをエクスポート">↓ disk.img</button>
    <button class="tbtn" onclick="importDiskImg()" title="disk.imgをインポート">↑ disk.img</button>
    <button class="tbtn" onclick="triggerImport()">import</button>
    <button class="tbtn red" onclick="doFormat()">format</button>
    <input type="file" id="importBin" multiple style="display:none" onchange="importFiles(event)">
    <input type="file" id="importDiskImg" accept=".img,.ima,.vfd" style="display:none" onchange="loadDiskImg(event)">
  </div>
  <div class="main">
    <pre id="screen" tabindex="0"><span id="screenText"></span><span id="cursor">&nbsp;</span></pre>
    <canvas id="gfxCanvas"></canvas>
    <span id="gfxBadge">GFX 320×200×256</span>
    <input id="hi" autocomplete="off" spellcheck="false" autocorrect="off" autocapitalize="none">
    <div class="side">
      <div class="side-label">DISK A:</div>
      <div class="disk-stat">
        <div>形式: <span>FAT12</span></div>
        <div>容量: <span>1,474,560B</span></div>
        <div>空き: <span id="freeBytes">—</span></div>
        <div>FILES: <span id="fileCount">0</span></div>
      </div>
      <div class="side-label" style="border-top:1px solid #0d0d0d">A:\<span id="cwdLabel"></span></div>
      <div id="fileList"></div>
      <div class="side-btns">
        <button class="sbtn" onclick="refreshUI()">↺ 更新</button>
        <button class="sbtn" onclick="MSDos.downloadImg()">↓ disk.img</button>
        <button class="sbtn" onclick="triggerImport()">↑ ファイルimport</button>
        <button class="sbtn" onclick="importDiskImg()">↑ disk.imgロード</button>
        <button class="sbtn danger" onclick="doFormat()">⚠ format</button>
      </div>
    </div>
  </div>
  <div class="sbar">
    <span id="cwdBar">A:\</span>
    <span id="videoModeSpan" style="color:#333"></span>
    <div class="bspc"></div>
    <span id="statusMsg"></span>
  </div>
</div>
<script src="./dist/cpu8086.js"></script>
<script src="./dist/msdos.js"></script>
<script>
// ============================================================
// ターミナルUI
// ============================================================
const screenEl   = document.getElementById('screen');
const screenText = document.getElementById('screenText');
const hiInput    = document.getElementById('hi');
const gfxCanvas  = document.getElementById('gfxCanvas');
const gfxCtx     = gfxCanvas.getContext('2d');
let   bufText    = '';
let   lineInput  = '';
let   inExec     = false;

// ScreenTerminal
class ScreenTerminal {
  print(s)      { if(window._cpuRunning)return; bufText+=s; render(); }
  println(s='') { if(window._cpuRunning)return; bufText+=(s||'')+'\n'; render(); }
  clear()       { bufText=''; render(); }
}

function render() {
  if(window._cpuRunning||window._gfxMode) return;
  const st=document.getElementById('screenText');
  if(st) st.textContent=bufText+lineInput;
  screenEl.scrollTop=screenEl.scrollHeight;
}

// focus
screenEl.addEventListener('click',()=>hiInput.focus());
screenEl.addEventListener('focus',()=>hiInput.focus());
gfxCanvas.addEventListener('click',()=>hiInput.focus());
hiInput.addEventListener('focus',()=>document.getElementById('cursor').style.display='inline-block');
hiInput.addEventListener('blur', ()=>document.getElementById('cursor').style.display='none');

// Mouse events → CPU
function updateMouse(e, canvas) {
  if (!window._cpuInstance) return;
  const rect = canvas.getBoundingClientRect();
  const scaleX = 320 / rect.width;
  const scaleY = 200 / rect.height;
  window._cpuInstance.mouseX = Math.max(0, Math.min(319, Math.floor((e.clientX - rect.left) * scaleX)));
  window._cpuInstance.mouseY = Math.max(0, Math.min(199, Math.floor((e.clientY - rect.top) * scaleY)));
}
gfxCanvas.addEventListener('mousemove', e => updateMouse(e, gfxCanvas));
gfxCanvas.addEventListener('mousedown', e => {
  if (!window._cpuInstance) return;
  updateMouse(e, gfxCanvas);
  if (e.button === 0) window._cpuInstance.mouseButtons |= 1;
  if (e.button === 2) window._cpuInstance.mouseButtons |= 2;
});
gfxCanvas.addEventListener('mouseup', e => {
  if (!window._cpuInstance) return;
  if (e.button === 0) window._cpuInstance.mouseButtons &= ~1;
  if (e.button === 2) window._cpuInstance.mouseButtons &= ~2;
});
gfxCanvas.addEventListener('contextmenu', e => e.preventDefault());

// ============================================================
// キー入力
// ============================================================
hiInput.addEventListener('keydown', e => {
  // EDIT モード
  if(window._editInstance&&window._editInstance.active){
    e.preventDefault();
    window._editInstance.onKey(e.key,e.ctrlKey,e.shiftKey);
    return;
  }
  // COPY CON モード
  if(window._copyConInstance&&window._copyConInstance.active){
    if(e.ctrlKey&&(e.key==='z'||e.key==='Z')){e.preventDefault();window._copyConInstance.onCtrlZ();if(window.onDiskChange)window.onDiskChange();return;}
    if(e.ctrlKey&&(e.key==='c'||e.key==='C')){e.preventDefault();window._copyConInstance.onCtrlC();return;}
    if(e.key==='Enter'){e.preventDefault();const l=lineInput;bufText+=lineInput+'\n';window._copyConInstance.onLine(l);lineInput='';render();return;}
    if(e.key==='Backspace'){e.preventDefault();if(lineInput.length>0){lineInput=lineInput.slice(0,-1);render();}return;}
    return;
  }
  // DEBUG モード
  if(window._debugMode){
    if(e.key==='Enter'){
      e.preventDefault();
      const l=lineInput;
      bufText+=lineInput+'\n';
      lineInput='';render();
      MSDos.shell._debugCmd(l);
      return;
    }
    if(e.key==='Backspace'){e.preventDefault();if(lineInput.length>0){lineInput=lineInput.slice(0,-1);render();}return;}
    return;
  }
  // CPU実行中 → キーをCPUへ
  if(window._cpuRunning&&window._cpuInstance){
    // Escape = 強制終了してDOSに戻る
    if(e.key==='Escape'){
      e.preventDefault();
      window._cpuRunning=false;
      window._cpuInstance=null;
      window._cpuMem=null;
      if(window._gfxMode) exitGFXMode();
      gfxCanvas.style.display='none';
      document.getElementById('screen').style.visibility='visible';
      const st=document.getElementById('screenText');
      if(st) st.textContent=bufText;
      MSDos.term.println('\n[ESC - プログラムを終了しました]');
      MSDos.shell.prompt();
      if(window.onDiskChange) window.onDiskChange();
      render();
      return;
    }
    let ascii=0,scan=0;
    if(e.key.length===1){ascii=e.key.charCodeAt(0);scan=ascii;}
    else if(e.key==='Enter'){ascii=0x0D;scan=0x1C;}
    else if(e.key==='Backspace'){ascii=0x08;scan=0x0E;}
    else if(e.key==='ArrowUp'){scan=0x48;ascii=0;}
    else if(e.key==='ArrowDown'){scan=0x50;ascii=0;}
    else if(e.key==='ArrowLeft'){scan=0x4B;ascii=0;}
    else if(e.key==='ArrowRight'){scan=0x4D;ascii=0;}
    if(ascii||scan){window._cpuInstance.pushKey(scan,ascii);window._cpuInstance.halted=false;}
    e.preventDefault();return;
  }
  if(inExec) return;
  if(e.key==='Enter'){
    e.preventDefault();
    const line=lineInput;
    bufText+=lineInput+'\n';lineInput='';render();
    inExec=true;
    MSDos.shell.execute(line);
    inExec=false;
    if(window.onDiskChange)window.onDiskChange();
  } else if(e.key==='Backspace'){
    e.preventDefault();
    if(lineInput.length>0){lineInput=lineInput.slice(0,-1);render();}
  } else if(e.key==='ArrowUp'){
    e.preventDefault();
    const h=MSDos.shell.history;if(!h.length)return;
    MSDos.shell.histIdx=Math.min(MSDos.shell.histIdx+1,h.length-1);
    lineInput=h[MSDos.shell.histIdx];render();
  } else if(e.key==='ArrowDown'){
    e.preventDefault();
    MSDos.shell.histIdx=Math.max(MSDos.shell.histIdx-1,-1);
    lineInput=MSDos.shell.histIdx<0?'':MSDos.shell.history[MSDos.shell.histIdx];render();
  } else if(e.key==='Tab'){
    e.preventDefault();tabComplete();
  } else if(e.ctrlKey&&e.key==='c'){
    bufText+='^C\n';lineInput='';render();MSDos.shell.prompt();
  }
});

hiInput.addEventListener('input', e=>{
  // CPU実行中・DEBUG中はIME無視
  if(window._cpuRunning||window._debugMode){hiInput.value='';return;}
  if(window._editInstance&&window._editInstance.active){
    for(const ch of hiInput.value) window._editInstance.onKey(ch,false,false);
    hiInput.value='';return;
  }
  const v=hiInput.value;
  if(v){lineInput+=v;hiInput.value='';render();}
});

function tabComplete(){
  const parts=lineInput.split(/\s+/);
  const last=parts[parts.length-1];if(!last)return;
  const entries=MSDos.disk.listDir(MSDos.shell.cwdParts)||[];
  const matches=entries.filter(e=>e.name.toUpperCase().startsWith(last.toUpperCase()));
  if(matches.length===1){parts[parts.length-1]=matches[0].name;lineInput=parts.join(' ');render();}
  else if(matches.length>1){bufText+='\n'+matches.map(m=>m.name.padEnd(14)).join('')+'\n';MSDos.shell.prompt();}
}

// ============================================================
// グラフィックモード (Mode 13h: 320x200x256色)
// ============================================================
window._gfxMode = false;

// DOS256色パレット (VGA標準)
const VGA_PALETTE = (() => {
  const p = new Uint8Array(256*3);
  // 0-15: EGA色
  const ega = [
    0,0,0, 0,0,170, 0,170,0, 0,170,170,
    170,0,0, 170,0,170, 170,85,0, 170,170,170,
    85,85,85, 85,85,255, 85,255,85, 85,255,255,
    255,85,85, 255,85,255, 255,255,85, 255,255,255
  ];
  for(let i=0;i<16;i++){p[i*3]=ega[i*3];p[i*3+1]=ega[i*3+1];p[i*3+2]=ega[i*3+2];}
  // 16-231: 6x6x6カラーキューブ
  for(let i=0;i<216;i++){
    const r=Math.floor(i/36)*51, g=Math.floor((i%36)/6)*51, b=(i%6)*51;
    p[(i+16)*3]=r;p[(i+16)*3+1]=g;p[(i+16)*3+2]=b;
  }
  // 232-255: グレースケール
  for(let i=0;i<24;i++){const v=i*10+8;p[(i+232)*3]=v;p[(i+232)*3+1]=v;p[(i+232)*3+2]=v;}
  return p;
})();

function renderGFX() {
  if(!window._cpuMem||!window._gfxMode) return;
  const mem = window._cpuMem;
  const GFX = 0xA0000;
  const W=320, H=200;
  const imgData = gfxCtx.createImageData(W, H);
  const px = imgData.data;
  for(let i=0;i<W*H;i++){
    const ci = mem.read8(GFX+i);
    px[i*4]   = VGA_PALETTE[ci*3];
    px[i*4+1] = VGA_PALETTE[ci*3+1];
    px[i*4+2] = VGA_PALETTE[ci*3+2];
    px[i*4+3] = 255;
  }
  gfxCtx.putImageData(imgData, 0, 0);
}

function enterGFXMode() {
  window._gfxMode = true;
  // canvasサイズ設定
  const mainEl = document.querySelector('.main');
  const tw = mainEl.clientWidth - 200; // side panel
  const th = mainEl.clientHeight;
  const scale = Math.min(Math.floor(tw/320), Math.floor(th/200)) || 1;
  gfxCanvas.width  = 320;
  gfxCanvas.height = 200;
  gfxCanvas.style.width  = (320*scale)+'px';
  gfxCanvas.style.height = (200*scale)+'px';
  gfxCanvas.style.display = 'block';
  gfxCanvas.style.top = Math.floor((th - 200*scale)/2)+'px';
  gfxCanvas.style.left= Math.floor((tw - 320*scale)/2)+'px';
  document.getElementById('screen').style.visibility='hidden';
  document.getElementById('gfxBadge').style.display='block';
  document.getElementById('videoModeSpan').textContent='MODE 13h 320×200×256';
  hiInput.focus();
}

function exitGFXMode() {
  window._gfxMode = false;
  gfxCanvas.style.display='none';
  document.getElementById('screen').style.visibility='visible';
  document.getElementById('gfxBadge').style.display='none';
  document.getElementById('videoModeSpan').textContent='';
  const st=document.getElementById('screenText');
  if(st) st.textContent=bufText;
  screenEl.scrollTop=screenEl.scrollHeight;
}

// ====== CP437 Canvas Text Mode Renderer ======
// CGA 16-color palette (RGB)
const CGA_PAL = [[0,0,0],[0,0,170],[0,170,0],[0,170,170],[170,0,0],[170,0,170],[170,85,0],[170,170,170],[85,85,85],[85,85,255],[85,255,85],[85,255,255],[255,85,85],[255,85,255],[255,255,85],[255,255,255]];
// CP437 8×8 bitmap font — full 256 char set (each char = 8 bytes, MSB = leftmost pixel)
const CP437 = new Uint8Array([
0,0,0,0,0,0,0,0, 126,129,165,129,189,153,129,126, 126,255,219,255,195,231,255,126, 108,254,254,254,124,56,16,0,
16,56,124,254,124,56,16,0, 56,124,56,254,254,124,56,124, 16,16,56,124,254,124,56,124, 0,0,24,60,60,24,0,0,
255,255,231,195,195,231,255,255, 0,60,102,66,66,102,60,0, 255,195,153,189,189,153,195,255, 15,7,15,125,204,204,204,120,
60,102,102,102,60,24,126,24, 63,51,63,48,48,112,240,224, 127,99,127,99,99,103,230,192, 153,90,60,231,231,60,90,153,
128,224,248,254,248,224,128,0, 2,14,62,254,62,14,2,0, 24,60,126,24,24,126,60,24, 102,102,102,102,102,0,102,0,
127,219,219,123,27,27,27,0, 62,99,56,108,108,56,204,120, 0,0,0,0,126,126,126,0, 24,60,126,24,126,60,24,255,
24,60,126,24,24,24,24,0, 24,24,24,24,126,60,24,0, 0,24,12,254,12,24,0,0, 0,48,96,254,96,48,0,0,
0,0,192,192,192,254,0,0, 0,36,102,255,102,36,0,0, 0,24,60,126,255,255,0,0, 0,255,255,126,60,24,0,0,
0,0,0,0,0,0,0,0, 24,60,60,24,24,0,24,0, 108,108,108,0,0,0,0,0, 108,108,254,108,254,108,108,0,
24,126,192,124,6,252,24,0, 0,198,204,24,48,102,198,0, 56,108,56,118,220,204,118,0, 24,24,48,0,0,0,0,0,
12,24,48,48,48,24,12,0, 48,24,12,12,12,24,48,0, 0,102,60,255,60,102,0,0, 0,24,24,126,24,24,0,0,
0,0,0,0,0,24,24,48, 0,0,0,126,0,0,0,0, 0,0,0,0,0,24,24,0, 6,12,24,48,96,192,128,0,
124,198,206,222,246,230,124,0, 24,56,120,24,24,24,126,0, 124,198,6,28,48,102,254,0, 124,198,6,60,6,198,124,0,
12,28,60,108,254,12,12,0, 254,192,252,6,6,198,124,0, 56,96,192,252,198,198,124,0, 254,198,12,24,48,48,48,0,
124,198,198,124,198,198,124,0, 124,198,198,126,6,12,120,0, 0,24,24,0,0,24,24,0, 0,24,24,0,0,24,24,48,
6,12,24,48,24,12,6,0, 0,0,126,0,0,126,0,0, 96,48,24,12,24,48,96,0, 124,198,12,24,24,0,24,0,
124,198,222,222,222,192,120,0, 56,108,198,198,254,198,198,0, 252,102,102,124,102,102,252,0, 60,102,192,192,192,102,60,0,
248,108,102,102,102,108,248,0, 254,98,104,120,104,98,254,0, 254,98,104,120,104,96,240,0, 60,102,192,192,206,102,62,0,
198,198,198,254,198,198,198,0, 60,24,24,24,24,24,60,0, 30,12,12,12,204,204,120,0, 230,102,108,120,108,102,230,0,
240,96,96,96,98,102,254,0, 198,238,254,254,214,198,198,0, 198,230,246,222,206,198,198,0, 56,108,198,198,198,108,56,0,
252,102,102,124,96,96,240,0, 124,198,198,198,214,222,124,6, 252,102,102,124,108,102,230,0, 124,198,224,120,14,198,124,0,
126,126,90,24,24,24,60,0, 198,198,198,198,198,198,124,0, 198,198,198,198,108,56,16,0, 198,198,198,214,254,238,198,0,
198,198,108,56,56,108,198,0, 102,102,102,60,24,24,60,0, 254,198,140,24,50,102,254,0, 60,48,48,48,48,48,60,0,
192,96,48,24,12,6,2,0, 60,12,12,12,12,12,60,0, 16,56,108,198,0,0,0,0, 0,0,0,0,0,0,0,255,
48,48,24,0,0,0,0,0, 0,0,120,12,124,204,118,0, 224,96,96,124,102,102,220,0, 0,0,124,198,192,198,124,0,
28,12,12,124,204,204,118,0, 0,0,124,198,254,192,124,0, 56,108,96,240,96,96,240,0, 0,0,118,204,204,124,12,248,
224,96,108,118,102,102,230,0, 24,0,56,24,24,24,60,0, 6,0,6,6,6,102,102,60, 224,96,102,108,120,108,230,0,
56,24,24,24,24,24,60,0, 0,0,236,254,214,214,198,0, 0,0,220,102,102,102,102,0, 0,0,124,198,198,198,124,0,
0,0,220,102,102,124,96,240, 0,0,118,204,204,124,12,30, 0,0,220,118,102,96,240,0, 0,0,124,192,124,6,252,0,
16,48,124,48,48,52,24,0, 0,0,204,204,204,204,118,0, 0,0,198,198,198,108,56,0, 0,0,198,214,214,254,108,0,
0,0,198,108,56,108,198,0, 0,0,198,198,206,118,6,198, 0,0,254,12,56,96,254,0, 14,24,24,112,24,24,14,0,
24,24,24,0,24,24,24,0, 112,24,24,14,24,24,112,0, 118,220,0,0,0,0,0,0, 0,16,56,108,198,198,254,0,
// 0x80-0xAF (mostly empty/accented - fill with 0 for now)
0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,
// 0xB0 - box drawing and blocks
85,170,85,170,85,170,85,170, 170,85,170,85,170,85,170,85, 221,187,221,187,221,187,221,187, 24,24,24,24,24,24,24,24,
24,24,24,248,24,24,24,24, 24,24,248,24,248,24,24,24, 54,54,54,246,54,54,54,54, 0,0,0,254,54,54,54,54,
0,0,248,24,248,24,24,24, 54,54,246,6,246,54,54,54, 54,54,54,54,54,54,54,54, 0,0,254,6,246,54,54,54,
54,54,246,6,254,0,0,0, 54,54,54,254,0,0,0,0, 24,24,248,24,248,0,0,0, 0,0,0,248,24,24,24,24,
24,24,24,31,0,0,0,0, 24,24,24,255,0,0,0,0, 0,0,0,255,24,24,24,24, 24,24,24,31,24,24,24,24,
0,0,0,255,0,0,0,0, 24,24,24,255,24,24,24,24, 24,24,31,24,31,24,24,24, 54,54,54,55,54,54,54,54,
54,54,55,48,63,0,0,0, 0,0,63,48,55,54,54,54, 54,54,247,0,255,0,0,0, 0,0,255,0,247,54,54,54,
54,54,55,48,55,54,54,54, 0,0,255,0,255,0,0,0, 54,54,247,0,247,54,54,54, 24,24,255,0,255,0,0,0,
54,54,54,255,0,0,0,0, 0,0,255,0,255,24,24,24, 0,0,0,255,54,54,54,54, 54,54,54,63,0,0,0,0,
24,24,31,24,31,0,0,0, 0,0,31,24,31,24,24,24, 0,0,0,63,54,54,54,54, 54,54,54,255,54,54,54,54,
24,24,255,24,255,24,24,24, 24,24,24,248,0,0,0,0, 0,0,0,31,24,24,24,24, 255,255,255,255,255,255,255,255,
0,0,0,0,255,255,255,255, 240,240,240,240,240,240,240,240, 15,15,15,15,15,15,15,15, 255,255,255,255,0,0,0,0,
// 0xE0-0xFF
0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,126,126,126,126,0,0, 0,0,0,0,0,0,0,0,
// 0xF0-0xFF
0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,0,126,126,126,126,0,0, 0,0,0,0,0,0,0,0
]);

let _txtCvs=null, _txtCtx=null;
function renderTextVRAM(){
  if(!window._cpuMem)return;
  if(!_txtCvs){_txtCvs=document.createElement('canvas');_txtCvs.width=640;_txtCvs.height=400;_txtCtx=_txtCvs.getContext('2d');}
  const mem=window._cpuMem, VRAM=0xB8000, W=80, H=25;
  const img=_txtCtx.createImageData(640,400), d=img.data;
  for(let r=0;r<H;r++) for(let c=0;c<W;c++){
    const ch=mem.read8(VRAM+(r*W+c)*2), at=mem.read8(VRAM+(r*W+c)*2+1);
    const fg=CGA_PAL[at&15], bg=CGA_PAL[(at>>4)&7];
    for(let y=0;y<16;y++){
      const bits=CP437[ch*8+(y>>1)];
      for(let x=0;x<8;x++){
        const on=(bits>>(7-x))&1, i=((r*16+y)*640+c*8+x)*4;
        d[i]=on?fg[0]:bg[0]; d[i+1]=on?fg[1]:bg[1]; d[i+2]=on?fg[2]:bg[2]; d[i+3]=255;
      }
    }
  }
  _txtCtx.putImageData(img,0,0);
  // Display on gfxCanvas
  const el=document.querySelector('.main'), tw=el.clientWidth-200, th=el.clientHeight;
  const sc=Math.max(0.5,Math.min(tw/640,th/400));
  gfxCanvas.width=640;gfxCanvas.height=400;
  gfxCanvas.style.width=Math.floor(640*sc)+'px';gfxCanvas.style.height=Math.floor(400*sc)+'px';
  gfxCanvas.style.display='block';
  gfxCanvas.style.top=Math.floor((th-400*sc)/2)+'px';gfxCanvas.style.left=Math.floor((tw-640*sc)/2)+'px';
  gfxCtx.drawImage(_txtCvs,0,0);
  document.getElementById('screen').style.visibility='hidden';
}

// ============================================================
// 初期化
// ============================================================
window.addEventListener('DOMContentLoaded', ()=>{
  const fakeTerm = new ScreenTerminal();
  window.onDiskChange = refreshUI;

  MSDos.term  = fakeTerm;
  MSDos.disk  = new FAT12Disk();
  if(!MSDos.disk.isFormatted()){MSDos.disk.format();fakeTerm.println('[新しいディスクをフォーマットしました]');}
  else fakeTerm.println('[ディスクをlocalStorageから読み込みました]');
  MSDos.shell = new DOSShell(MSDos.disk, fakeTerm);
  MSDos.shell.start();
  refreshUI();
  hiInput.focus();

  // EDITレンダリング (カーソル付き)
  window._editRender=(text, cursorRow, cursorCol)=>{
    const st=document.getElementById('screenText');
    if(!st)return;
    // Hide normal cursor during EDIT
    document.getElementById('cursor').style.display='none';
    // Split text into lines, insert cursor character with highlight
    const lines=text.split('\n');
    let html='';
    for(let i=0;i<lines.length;i++){
      if(i>0)html+='\n';
      if(i===cursorRow){
        const line=lines[i];
        const col=Math.min(cursorCol,line.length);
        const before=line.slice(0,col);
        const curCh=col<line.length?line[col]:' ';
        const after=col<line.length?line.slice(col+1):'';
        // Escape HTML
        const esc=s=>s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        html+=esc(before)+'<span class="edit-cursor">'+esc(curCh)+'</span>'+esc(after);
      } else {
        const esc=s=>s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        html+=esc(lines[i]);
      }
    }
    st.innerHTML=html;
    screenEl.scrollTop=screenEl.scrollHeight;
  };
  window._editExit=()=>{
    const st=document.getElementById('screenText');
    if(st){st.textContent=bufText+lineInput;st.innerHTML=st.textContent.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
    document.getElementById('cursor').style.display='inline-block';
  };

  // DEBUGモード: promptとexec
  window._debugPrompt=()=>{ bufText+='-'; render(); };
  window._debugExec=(l)=>{ MSDos.shell._debugCmd(l); };

  // VRAMレンダリング (テキスト or グラフィック)
  window.renderVRAM = ()=>{
    if(window._gfxMode) renderGFX();
    else renderTextVRAM();
  };

  // グラフィックモード切り替えコールバック (cpu8086.jsから呼ばれる)
  window._onVideoModeChange = (mode)=>{
    if(mode===0x13) enterGFXMode();
    else if(window._gfxMode) exitGFXMode();
  };

  // exitVRAMMode (テキストモード復帰)
  window.exitVRAMMode=()=>{
    if(window._gfxMode) exitGFXMode();
    const st=document.getElementById('screenText');
    if(st)st.textContent=bufText;
    screenEl.scrollTop=screenEl.scrollHeight;
  };

  setInterval(()=>{
    const c=MSDos.shell?MSDos.shell.cwdStr():'A:\\';
    document.getElementById('cwdBar').textContent=c;
    document.getElementById('cwdLabel').textContent=MSDos.shell?MSDos.shell.cwdParts.join('\\'):'';
  },200);
});

// ============================================================
// サイドパネル / ファイル操作
// ============================================================
function refreshUI(){
  if(!MSDos.disk||!MSDos.shell) return;
  const entries=MSDos.disk.listDir(MSDos.shell.cwdParts)||[];
  const el=document.getElementById('fileList');
  if(!entries.length){el.innerHTML='<div class="fe" style="cursor:default;color:#1a1a1a">（空）</div>';}
  else{
    el.innerHTML=entries.map(e=>{
      const isDir=e.attr&0x10;
      const label=isDir?'['+e.name+']':e.name;
      const size=isDir?'DIR':e.size+'B';
      const act=isDir?`sendCmd('CD ${e.name}')`:`sendCmd('TYPE ${e.name}')`;
      return `<div class="fe${isDir?' dir':''}" onclick="${act}"><span class="fn">${label}</span><span class="fs">${size}</span></div>`;
    }).join('');
  }
  const free=MSDos.disk.freeClusters()*512;
  document.getElementById('freeBytes').textContent=free.toLocaleString()+'B';
  document.getElementById('fileCount').textContent=entries.filter(e=>!(e.attr&0x10)).length;
}

function sendCmd(cmd){
  bufText+=cmd+'\n';lineInput='';render();
  MSDos.shell.execute(cmd);refreshUI();
  hiInput.focus();
}

function doFormat(){
  if(!confirm('FORMAT: 全データが削除されます。続行しますか？')) return;
  MSDos.format();refreshUI();setStatus('FORMAT 完了');
}

function triggerImport(){
  document.getElementById('importBin').click();
}
function importDiskImg(){
  document.getElementById('importDiskImg').click();
}

function loadDiskImg(e){
  const file = e.target.files[0];
  if(!file){ return; }
  const r = new FileReader();
  r.onload = ev => {
    const bytes = new Uint8Array(ev.target.result);
    if(bytes.length < 512){ setStatus('不正なimgファイル'); return; }

    // 1. ディスクを全消去してバイトを書き込む
    MSDos.disk.wipeStorage();
    MSDos.disk._cache = {};
    MSDos.disk._dirty = new Set();

    const sectors = Math.min(Math.floor(bytes.length / 512), MSDos.disk.TOTAL_SECTORS);
    for(let n = 0; n < sectors; n++){
      const sec = MSDos.disk._sec(n);
      for(let i = 0; i < 512; i++) sec[i] = bytes[n*512+i];
      MSDos.disk._dirty.add(n);
    }
    MSDos.disk.flush();

    // 2. シェルを再起動（再起動演出）
    bufText = '';
    lineInput = '';
    render();

    const term = MSDos.term;
    term.println('');
    term.println('disk.img をロードしました: ' + file.name);
    term.println('(' + bytes.length.toLocaleString() + ' bytes, ' + sectors + ' sectors)');
    term.println('');
    term.println('システムを再起動しています...');

    setTimeout(() => {
      bufText = '';
      lineInput = '';
      // shellを新しく作り直す
      MSDos.shell = new DOSShell(MSDos.disk, term);
      MSDos.shell.start();
      refreshUI();
      hiInput.focus();
      setStatus('disk.imgロード完了');
    }, 800);
  };
  r.readAsArrayBuffer(file);
  e.target.value = '';
}

function importFiles(e, type){
  importFileList(Array.from(e.target.files));
  e.target.value='';
}

function importFileList(files){
  let count=0;
  const proms=files.map(f=>new Promise(res=>{
    const r=new FileReader();
    r.onload=ev=>{
      const bytes=new Uint8Array(ev.target.result);
      // 画像インポートの場合: ファイル名をそのままディスクに保存
      const saveName = f.name.toUpperCase().replace(/[^A-Z0-9._]/g,'_').slice(0,12);
      const result=MSDos.importFile(saveName, bytes);
      if(result===true){
        MSDos.term.println(`[インポート: ${saveName} (${bytes.length}B) → A:\\]`);
        count++;
      } else {
        MSDos.term.println(`[エラー: ${f.name} - ${result}]`);
      }
      res();
    };
    r.readAsArrayBuffer(f);
  }));
  Promise.all(proms).then(()=>{
    MSDos.shell.prompt();refreshUI();
    setStatus(`${count}ファイルをインポート`);
    hiInput.focus();
  });
}

function setStatus(msg){
  document.getElementById('statusMsg').textContent=msg;
  setTimeout(()=>document.getElementById('statusMsg').textContent='',3000);
}

// ドラッグ&ドロップ
const overlay=document.getElementById('dropOverlay');
document.addEventListener('dragenter',e=>{e.preventDefault();overlay.classList.add('active');});
document.addEventListener('dragleave',e=>{if(!e.relatedTarget)overlay.classList.remove('active');});
document.addEventListener('dragover',e=>e.preventDefault());
document.addEventListener('drop',e=>{e.preventDefault();overlay.classList.remove('active');importFileList(Array.from(e.dataTransfer.files));});

// postMessage (index.htmlから)
window.addEventListener('message',e=>{
  if(e.data&&e.data.type==='save_com'){
    const{name,bytes}=e.data;
    const r=MSDos.saveCom(name,bytes);
    if(r===true){refreshUI();setStatus('受信: '+name);MSDos.term.println(`[${name}→A:\\ (${bytes.length}B)]`);MSDos.shell.prompt();}
    else setStatus('エラー: '+r);
  }
});
</script>
</body>
</html>
